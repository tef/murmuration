<!doctype html> 
<html> 
	<head> 
		<title>mumuration</title> 
		<meta charset="utf-8" /> 
	</head> 
	<body>
		<div align="center">
            <canvas id="c"></canvas>
		</div> 
		<script> 

function Flock(config) {
    this.size = config.size;
    this.dim = config.dim;
    this.positions = Array(config.size*config.dim);
    this.velocities = Array(config.size *config.dim);

    this.alignment_radius=config.alignment_radius;
    this.cohesion_radius=config.cohesion_radius;
    this.separation_radius=config.separation_radius;
    console.log(config, this)

    return this;
}

Flock.prototype.reset = function(radius) {
    for (var i=0; i<this.size; i++) {
        for (var j=0; j < this.dim; j++) {
            this.positions[i+j] = Math.random()*radius*2-radius;
            this.velocities[i+j] = Math.random()*2-1;
        }
    }
}

Flock.prototype.get_pos = function(bird) {
    return this.positions.slice(bird, bird+this.dim);
}

Flock.prototype.get_vel = function(bird) {
    return this.velocities.slice(bird, bird+this.dim);
}

Flock.prototype.set_pos = function(bird,p) {
    for (j=0; j<this.dim; j++) {
        this.positions[bird+j] = p[j];
    }
}

Flock.prototype.set_vel = function(bird,v) {
    for (j=0; j<this.dim; j++) {
        this.velocities[bird+j] = v[j];
    }
}

Flock.prototype.get_neighbours = function(bird) {
    var neighbours = []
    for (var n=0; n<this.size; n++) {
        if (n!=bird) {

            var d = this.get_distance(bird, n);
            var c = [n,d];
            neighbours.push(c);
        }
    }
    return neighbours;
}

Flock.prototype.get_distance = function(bird, n) {
    var pb = this.get_pos(bird);
    var pn = this.get_pos(n);
    var t = 0;
    for (var i=0; i<this.dim; i++) {
        t+=Math.pow(pb[i]-pn[i],2);
    }
    return Math.sqrt(t);
}

Flock.prototype.update_into = function(new_flock) {
    var social = [];
    for (var bird=0; bird<this.size; bird++) {
        var pos = this.get_pos(bird);
        var vel = this.get_vel(bird);

        // vec is aggregate velocity
        for (var i=0;i<this.dim;i++){social[i]=0}

        var nearby=0;
        var neighbours = this.get_neighbours(bird)
        for (var i =0; i<neighbours.length; i++) {
            var neighbour=neighbours[i], n=neighbours[0], d=neighbour[1];
            nearby++;
            
            if (d < this.separation_radius) {
                // too close, fly away
                console.log('close', d, bird, n)

            } else if (d < this.alignment_radius) {
                // try to match velocity
                // find difference between average 
                console.log('align', d, bird, n)

            } else if (d > this.cohesion_radius)  {
                // try to match position
                // change velocity towards other bird
                console.log('cohesion', d, bird, n)
            } else {
                console.log(n,d);
            }

        }
        for (var j=0; j<this.dim; j++) {
            vel[j]=vel[j]+social[j]/nearby;
            pos[j]+=vel[j]+Math.random();
        }

        new_flock.set_pos(bird, pos);
        new_flock.set_vel(bird, vel);
    }
}
Flock.prototype.render = function(ctx, width, height,r) {
    for (var n=0; n<this.size; n++) {
        var p = this.get_pos(n);
        var x = p[0]+width/2;
        var y = p[1]+height/2;
        ctx.fillRect(x,y,r,r);
    }
}

var canvas=document.getElementById('c');
var ctx=canvas.getContext("2d");

window.onresize = function() {
    canvas.width = window.innerWidth*0.95;
    canvas.height = window.innerHeight*0.94;
}

window.onresize()

var config = {
    size: 2,
    dim: 2,
    bird_radius: 5,
    separation_radius: 25,
    alignment_radius: 50,
    cohesion_radius: 100,
}
var f1 = new Flock(config);
var f2 = new Flock(config);

f1.reset(config.size*5);

a=0
function paint() {
    a++;
    if (a>2) {return}
    var w=canvas.width,h=canvas.height;
    f1.update_into(f2)
    ctx.clearRect(0,0, w,h)
    ctx.fillStyle= 'black'
    f2.render(ctx,w,h, 3)
    f1=f2;
    setTimeout(paint)
}


setTimeout(paint);


		</script> 
	</body> 
</html>

